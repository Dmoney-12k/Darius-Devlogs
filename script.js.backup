/*Cart + UI*/

const CART_KEY = 'ecom_cart_v1';

//Cart items
let cart = loadCart();

//Safely parse price
function parsePrice(str) {
  const n = Number(String(str).replace(/[^0-9.]/g, ''));
  return isNaN(n) ? 0 : n;
}

function loadCart() {
  try {
    const raw = localStorage.getItem(CART_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    // Ensure shape
    if (Array.isArray(parsed)) {
      return parsed
        .map(it => ({
          id: it.id,
          name: String(it.name || ''),
          price: Number(it.price || 0),
          image: String(it.image || ''),
          qty: Number(it.qty || 1),
        }))
        .filter(it => it.name);
    }
  } catch (_) {}
  return [];
}

function saveCart() {
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
}

function getTotalQty() {
  return cart.reduce((sum, it) => sum + it.qty, 0);
}
function getSubtotal() {
  return cart.reduce((sum, it) => sum + it.qty * it.price, 0);
}

// UI badge
function updateBadge() {
  const badge = document.getElementById('cart-count');
  if (badge) badge.textContent = String(getTotalQty());
}

// UI drawer
function openCart() {
  const drawer = document.getElementById('cart-drawer');
  if (!drawer) return;
  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden', 'false');
}

function closeCart() {
  const drawer = document.getElementById('cart-drawer');
  if (!drawer) return;
  drawer.classList.remove('open');
  drawer.setAttribute('aria-hidden', 'true');
}

// Render cart items
function renderCart() {
  const list = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('cart-subtotal');
  if (!list || !subtotalEl) return;

  if (cart.length === 0) {
    list.innerHTML = '<p>Your cart is empty.</p>';
    subtotalEl.textContent = '$0.00';
    return;
  }

  list.innerHTML = cart
    .map(
      it => `
    <div class="cart-item" data-id="${it.id}">
      <img src="${it.image}" alt="${it.name}">
      <div class="meta">
        <h4>${it.name}</h4>
        <div class="controls">
          <button class="qty-btn" data-act="dec" aria-label="Decrease quantity">-</button>
          <span aria-live="polite">${it.qty}</span>
          <button class="qty-btn" data-act="inc" aria-label="Increase quantity">+</button>
          <button class="remove-btn" data-act="remove" aria-label="Remove item">Remove</button>
        </div>
      </div>
      <div class="price">$${(it.price * it.qty).toFixed(2)}</div>
    </div>
  `
    )
    .join('');

  subtotalEl.textContent = `$${getSubtotal().toFixed(2)}`;
}

// Add to cart from a product element
function addProductFromCard(cardEl) {
  if (!cardEl) return;
  const nameEl = cardEl.querySelector('h3');
  const priceEl = cardEl.querySelector('.price');
  const imgEl = cardEl.querySelector('img');

  const name = nameEl ? nameEl.textContent.trim() : 'Product';
  const price = parsePrice(priceEl ? priceEl.textContent : '0');
  const image = imgEl ? imgEl.src : '';
  const id = name.toLowerCase().replace(/\s+/g, '-');

  // conditionals
  const existing = cart.find(it => it.id === id);
  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({ id, name, price, image, qty: 1 });
  }
  saveCart();
  updateBadge();
  renderCart();
}

// Change quantity / remove
function changeQty(id, delta) {
  for (let i = 0; i < cart.length; i++) {
    // loop
    if (cart[i].id === id) {
      cart[i].qty += delta;
      if (cart[i].qty <= 0) cart.splice(i, 1);
      break;
    }
  }
  saveCart();
  updateBadge();
  renderCart();
}

function removeItem(id) {
  cart = cart.filter(it => it.id !== id);
  saveCart();
  updateBadge();
  renderCart();
}

// Event bindings
function bindEvents() {
  // Open cart via header cart button
  const cartBtn = document.querySelector('.icon-btn.cart');
  if (cartBtn) cartBtn.addEventListener('click', openCart);

  // Close cart via X
  const closeBtn = document.getElementById('cart-close');
  if (closeBtn) closeBtn.addEventListener('click', closeCart);
  const backdrop = document.getElementById('cart-backdrop');
  if (backdrop) backdrop.addEventListener('click', closeCart);

  // Delegate clicks for add-to-cart buttons
  document.addEventListener('click', e => {
    const btn = e.target.closest('.add-to-cart');
    if (btn) {
      const card = btn.closest('.box');
      addProductFromCard(card);
      // add small animation feedback
      btn.classList.add('added');
      setTimeout(() => btn.classList.remove('added'), 1200);
      return;
    }

    // Handle cart item
    const itemEl = e.target.closest('.cart-item');
    if (itemEl) {
      const id = itemEl.getAttribute('data-id');
      if (e.target.matches('[data-act="inc"]')) changeQty(id, +1);
      if (e.target.matches('[data-act="dec"]')) changeQty(id, -1);
      if (e.target.matches('[data-act="remove"]')) removeItem(id);
    }

    // Checkout button - navigate to checkout.html
    if (e.target.closest('#checkout-btn')) {
      window.location.href = 'checkout.html';
    }
  });
}

//  simple button to show event
(function bindHeroButton() {
  const boom = document.getElementById('boomBtn');
  const title = document.getElementById('hero-title');
  if (boom && title) {
    boom.addEventListener('click', () => {
      title.classList.toggle('big');
    });
  }
})();

// Initialize on DOM
window.addEventListener('DOMContentLoaded', () => {
  updateBadge();
  renderCart();
  bindEvents();

  // ScrollReveal
  if (window.ScrollReveal) {
    const sr = ScrollReveal({ distance: '40px', duration: 800, reset: false });
    sr.reveal('.home-text', { origin: 'left', delay: 150 });
    sr.reveal('.home-img', { origin: 'right', delay: 200 });
    sr.reveal('.feature-content .row', { interval: 80, origin: 'bottom' });
  }
});
